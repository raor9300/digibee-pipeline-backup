name: updated-pipeline
run-name: ${{ github.actor }} is committing pipeline changes

on: 
  push:
    branches:
      - '*'
      - '*/*'
      - '**'
      - '!main'
      - '!master'

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install digibeectl
        run: |
          echo "Installing digibeectl"
          curl -s https://storage.googleapis.com/digibee-release-test/releases/install.sh | bash
          digibeectl --help

      # ----------------------------
      # Configure digibeectl (REQUIRED)
      # ----------------------------
      - name: Configure Digibee credentials
        run: |
          mkdir -p ~/.digibeectl
          touch ~/.digibeectl/config.enc

          digibeectl config set \
            --auth-key "${{ secrets.PASS }}" \
            --secret-key "${{ secrets.KEY }}" \
            --file ~/.digibeectl/config.enc

      # ----------------------------
      # Read metadata
      # ----------------------------
      - name: Read metadata.json
        run: |
          echo "PIPELINE=$(jq -r .pipelineName metadata.json)" >> "$GITHUB_ENV"
          echo "MAJ_VERSION=$(jq -r .majorVersion metadata.json)" >> "$GITHUB_ENV"

      # ----------------------------
      # Resolve pipeline ID
      # ----------------------------
      - name: Resolve pipeline ID
        run: |
          PIPELINE_ID=$(digibeectl get pipeline --name "$PIPELINE" \
            | awk -v pipe="$PIPELINE" -v maj="$MAJ_VERSION" '
              $1 == pipe && index($0, maj) { print $2; exit }
            ')

          if [ -z "$PIPELINE_ID" ]; then
            echo "âŒ Pipeline not found: name=$PIPELINE version=$MAJ_VERSION"
            echo "Available pipelines:"
            digibeectl get pipeline --name "$PIPELINE"
            exit 1
          fi

          echo "PIPELINE_ID=$PIPELINE_ID" >> "$GITHUB_ENV"

      # ----------------------------
      # Download flowspec
      # ----------------------------
      - name: Download flowspec
        run: |
          digibeectl get pipeline --pipeline-id "$PIPELINE_ID" --flowspec \
            | jq . > flowspec.json

      # ----------------------------
      # Add audit note
      # ----------------------------
      - name: Add githubbot note
        run: |
          echo "Modified by githubbot at $(date)" >> githubbot.md

      # ----------------------------
      # Commit changes
      # ----------------------------
      - name: Commit with GITHUB_TOKEN
        run: |
          git config user.email github-actions[bot]@users.noreply.github.com
          git config user.name "GitHub Actions Bot"
          git add flowspec.json githubbot.md
          git commit -m "Automatic commit by githubactions [skip actions]" || echo "No changes to commit"
          git push