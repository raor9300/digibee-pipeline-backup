name: updated-pipeline
run-name: ${{ github.actor }} is committing pipeline changes

on: 
  push:
    branches:
      - '*'
      - '*/*'
      - '**'
      - '!main'
      - '!master'

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repository
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install digibeectl
        run: |
          echo "Installing digibeectl"
          curl -s https://storage.googleapis.com/digibee-release-test/releases/install.sh | bash
          digibeectl --help

      # ----------------------------
      # Extract metadata
      # ----------------------------
      - name: Read metadata.json
        run: |
          echo "PIPELINE=$(jq -r .pipelineName metadata.json)" >> "$GITHUB_ENV"
          echo "MAJ_VERSION=$(jq -r .majorVersion metadata.json)" >> "$GITHUB_ENV"
      
      # ----------------------------
      # Configure digibeectl
      # ----------------------------
      - name: Configure digibeectl with JSON + keys
        env:
          DIGIBEE_TOKEN: ${{ secrets.TOKEN }}
          DIGIBEE_KEY: ${{ secrets.KEY }}
          DIGIBEE_PASS: ${{ secrets.PASS }}
        run: |
          mkdir -p ~/.digibeectl
          echo "$DIGIBEE_TOKEN" > ~/.digibeectl/token.json
          digibeectl config set --file ~/.digibeectl/token.json \
                                --secret-key "$DIGIBEE_KEY" \
                                --auth-key "$DIGIBEE_PASS"
      
      # ----------------------------
      # Resolve PIPELINE_ID
      # ----------------------------
      - name: Resolve PIPELINE_ID from JSON
        env:
          PIPELINE: ${{ env.PIPELINE }}
          MAJ_VERSION: ${{ env.MAJ_VERSION }}
        run: |
          PIPELINE_ID=$(digibeectl get pipeline --name "$PIPELINE" --output json \
            | jq -r --arg PIPE "$PIPELINE" --arg MAJ "$MAJ_VERSION" '
                .[] | select(.pipelineName == $PIPE and (.version | startswith($MAJ))) | .pipelineId
            ')
          
          if [ -z "$PIPELINE_ID" ]; then
            echo "âŒ Pipeline not found: name=$PIPELINE version=$MAJ_VERSION"
            digibeectl get pipeline --name "$PIPELINE" --output json | jq
            exit 1
          fi

          echo "PIPELINE_ID=$PIPELINE_ID" >> "$GITHUB_ENV"

      # ----------------------------
      # Download flowspec
      # ----------------------------
      - name: Download flowspec
        run: |
          digibeectl get pipeline --pipeline-id "$PIPELINE_ID" --flowspec \
            | jq . > flowspec.json

      # ----------------------------
      # Add audit note
      # ----------------------------
      - name: Add githubbot note
        run: |
          echo "Modified by githubbot at $(date) on branch $GITHUB_REF" >> githubbot.md

      # ----------------------------
      # Commit changes
      # ----------------------------
      - name: Commit and push changes
        run: |
          git config user.email github-actions[bot]@users.noreply.github.com
          git config user.name "GitHub Actions Bot"
          git add flowspec.json githubbot.md
          git commit -m "Automatic commit by githubactions [skip actions]" || echo "No changes to commit"
          git push